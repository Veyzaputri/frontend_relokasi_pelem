<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <title>Kelola Tokoh Masyarakat - Admin</title>
</head>
<body class="admin-page-body">
    <header class="navbar">
        <div class="container">
            <h1 class="logo">Relokasi Pelem</h1>
            <nav>
                <ul class="nav-links">
                    <li><a href="dashboard_admin.html">Beranda</a></li>
                    <li><a href="berita_admin.html">Berita</a></li>
                    <li><a href="sosial_kemanusiaan.html">Sosial & Kemanusiaan</a></li>
                    <li><a href="tokoh_masyarakat.html">Tokoh Masyarakat</a></li>
                    <li><a href="#">Organisasi</a></li>
                    <li><a href="#">Kontak Kami</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button class="btn logout">Logout</button>
            </div>
        </div>
    </header>

    <main>
        <div class="admin-container">
            <div class="admin-page-header">
                <h1>Kelola Tokoh Masyarakat</h1>
                <button class="btn-admin btn-primary" onclick="window.location.href='add_tokoh_masyarakat.html'">+ Tambah Tokoh</button>
            </div>
            
            <div class="admin-tokoh-grid" id="tokohContainer">
                </div>
        </div>
    </main>

    <footer class="footer-section">
        <p class="copyright">Â© 2025 Desa Relokasi Pelem. All rights reserved.</p>
    </footer>

<script>
    // --- Logika Utama Halaman ---
    document.addEventListener('DOMContentLoaded', () => {
        // Cek sesi login sebelum melakukan apapun
        fetch("https://backend-relokasi-pelem.vercel.app/whoami", { credentials: 'include' })
            .then(res => {
                if (!res.ok) throw new Error("Sesi tidak valid");
                return res.json();
            })
            .then(data => {
                if (data && data.id) {
                    loadTokoh(); // Jika login valid, muat data tokoh
                } else {
                    throw new Error("Sesi tidak ditemukan.");
                }
            })
            .catch(error => {
                alert("Sesi login Anda telah berakhir. Silakan login kembali.");
                window.location.href = "../login.html";
            });

        // Event listener untuk tombol logout
        const logoutBtn = document.querySelector('.btn.logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('https://backend-relokasi-pelem.vercel.app/logout', { method: 'DELETE', credentials: 'include' });
                    const data = await response.json();
                    alert(data.msg);
                    if (response.ok) window.location.href = "../index.html";
                } catch (error) {
                    alert("Terjadi kesalahan saat logout.");
                }
            });
        }
    });

    // --- Fungsi-fungsi Pembantu ---

    async function loadTokoh() {
        const container = document.getElementById("tokohContainer");
        container.innerHTML = "<p>Memuat data tokoh...</p>";

        try {
            const res = await fetch("https://backend-relokasi-pelem.vercel.app/tokoh", { credentials: "include" });
            const tokohList = await res.json();
            if (!Array.isArray(tokohList)) throw new Error('Data tidak valid');

            container.innerHTML = ""; // Kosongkan container

            const data = [...tokohList];

            const createTokohCard = (tokoh) => {
                const card = document.createElement("div");
                card.className = "admin-tokoh-card";
                const imagePath = tokoh.gambar || "../image/default.jpg";
                card.innerHTML = `
                    <img src="${imagePath}" alt="${tokoh.nama_tokoh}" onerror="this.onerror=null;this.src='../image/default.jpg';">
                    <div class="admin-tokoh-card-info">
                        <p>${tokoh.nama_tokoh}</p>
                        <span>${tokoh.jabatan}</span>
                    </div>
                    <div class="admin-tokoh-card-actions">
                        <a href="#" class="btn btn-edit-tokoh" onclick="event.preventDefault(); editTokoh(${tokoh.id_tokoh})">Edit</a>
                        <a href="#" class="btn btn-delete-tokoh" onclick="event.preventDefault(); deleteTokoh(${tokoh.id_tokoh})">Hapus</a>
                    </div>
                `;
                return card;
            };

            const createRow = () => {
                const row = document.createElement("div");
                row.className = "tokoh-row";
                return row;
            };

            const layoutRules = [1, 2, 4]; // Aturan layout piramida
            
            for (const rule of layoutRules) {
                if (data.length === 0) break;
                const row = createRow();
                const items = data.splice(0, rule);
                items.forEach(item => row.appendChild(createTokohCard(item)));
                container.appendChild(row);
            }

            while (data.length > 0) {
                const row = createRow();
                const items = data.splice(0, 4);
                items.forEach(item => row.appendChild(createTokohCard(item)));
                container.appendChild(row);
            }

        } catch (err) {
            container.innerHTML = "<p>Terjadi kesalahan saat memuat data tokoh.</p>";
        }
    }

    function editTokoh(id) {
        window.location.href = `edit_tokoh.html?id=${id}`;
    }

    async function deleteTokoh(id) {
        if (!confirm("Yakin ingin menghapus tokoh ini?")) return;
        try {
            const res = await fetch(`https://backend-relokasi-pelem.vercel.app/tokoh/${id}`, {
                method: "DELETE",
                credentials: "include"
            });
            const data = await res.json();
            alert(data.msg);
            if (res.ok) loadTokoh(); // Muat ulang data setelah berhasil hapus
        } catch (err) {
            alert("Gagal menghapus tokoh.");
        }
    }
</script>
</body>
</html>
